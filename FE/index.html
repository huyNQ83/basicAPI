<!doctype html>
<html lang="en">
  <head>
    <title>Title</title>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
    <link rel="stylesheet" href="style.css">
  </head>
  <body>
    <div class="container">
      <div class="row">
        <div class="col-12">
          <table class="table table-striped table-inverse table-responsive">
            <button type="button" class="btn btn-success btn-lg" data-toggle="modal" data-target="#createUserModal">Create user</button>
            <thead class="thead-inverse">
              <tr>
                <th>Email</th>
                <th>Name</th>
                <th>Password</th>
              </tr>
              </thead>
              <tbody id="tableBody">
               
                
              </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Create Modal -->
  <div class="modal fade" id="createUserModal" role="dialog">
    <div class="modal-dialog">
    
      <!-- Modal content-->
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal">&times;</button>
          <h4 class="modal-title">Modal Header</h4>
        </div>
        <div class="modal-body">
          <form>
            <div class="form-group">
              <label for="recipient-name" class="col-form-label">Name:</label>
              <input type="text" class="form-control" id="newUserName">
            </div>

            <div class="form-group">
              <label for="recipient-name" class="col-form-label">Email:</label>
              <input type="text" class="form-control" id="newUserEmail">
            </div>

            <div class="form-group">
              <label for="recipient-name" class="col-form-label">Password:</label>
              <input type="text" class="form-control" id="newUserPassword">
            </div>
            
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-default" data-dismiss="modal" id="close-create-modal">Close</button>
          <button type="button" class="btn btn-primary" id="create-user-btn">Create user</button>
        </div>
      </div>
      
    </div>
  </div>
    
    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>

    <script>
      const getUsers = async () => {
        try {
          const URI = `http://localhost:3000/api/users`;

          const response = await axios.get(URI);

          return response.data;

        } catch (error) {
          console.log("ðŸš€ ~ file: index.html ~ line 63 ~ getUsers ~ error", error)
          return [];
        }
      }

      const deleteUser = async (userId) => {
        try {
          const URI = `http://localhost:3000/api/user/${userId}`;

          const response = await axios.delete(URI);

          return response.data;

        } catch (error) {
          console.log("ðŸš€ ~ file: index.html ~ line 63 ~ deleteUsers ~ error", error)
          return [];
        }
      }

      const createUser = async (data) => {
        try {
          const URI = `http://localhost:3000/api/user`;

          const response = await axios.post(URI, data);

          return response.data;

        } catch (error) {
          console.log("ðŸš€ ~ file: index.html ~ line 63 ~ deleteUsers ~ error", error)
          return [];
        }
      }

      const handleDeleteUser = async (element) => {
        const userId = element.dataset.userid;
        console.log("ðŸš€ ~ file: index.html ~ line 108 ~ deleteBtn.addEventListener ~ userId", userId);

        const deletedUser = await deleteUser(userId);
        console.log("ðŸš€ ~ file: index.html ~ line 123 ~ deleteBtn.addEventListener ~ deletedUser", deletedUser);

        // get all users
        const users = await getUsers();

        // Remove old users value
        const tableBody = document.querySelector('#tableBody');
        tableBody.innerHTML = '';

        // Render new users value
        renderUsersTable(users);
      }

      const renderUsersTable = (users) => {
        const tableBody = document.querySelector('#tableBody');
        
        users.forEach(user => {
          let html = `<tr>
                        <td>${user.email}</td>
                        <td>${user.name}</td>
                        <td>${user.password}</td>
                        <td><button class="btn btn-danger deleteUserBtn" data-userId=${user._id} onClick="handleDeleteUser(this)">Delete</button></td>
                      </tr>`;
          tableBody.insertAdjacentHTML('afterbegin', html);
        })
      }

      document.addEventListener("DOMContentLoaded", async (event) => {
        const users = await getUsers();
        renderUsersTable(users);

        const createUserBtn = document.querySelector('#create-user-btn');
        
        createUserBtn.addEventListener('click', async (event) => {

          // Get user's input from create user modal
          const name = document.querySelector('#newUserName').value;          
          const email = document.querySelector('#newUserEmail').value;          
          const password = document.querySelector('#newUserPassword').value;          

          // Setup payload for create new user
          const payload = {
            name,
            email,
            password
          }

          // Create new user by calling api
          const newUser = await createUser(payload);

          // Close create modal after finsish
          const closeModalBtn = document.querySelector('#close-create-modal');
          closeModalBtn.click();

          // Render new user's data into table of users
          const tableBody = document.querySelector('#tableBody');
          let html = `<tr>
                        <td>${newUser.email}</td>
                        <td>${newUser.name}</td>
                        <td>${newUser.password}</td>
                        <td><button class="btn btn-danger deleteUserBtn" data-userId=${newUser._id} onClick="handleDeleteUser(this)">Delete</button></td>
                      </tr>`;
          tableBody.insertAdjacentHTML('afterbegin', html);
        })
      });
    </script>
  </body>
</html>